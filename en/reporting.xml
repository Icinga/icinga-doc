<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE section [
<!ENTITY % all.entities SYSTEM "all-entities.ent">
%all.entities;
]>
<section version="5.0" xml:id="reporting" xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"
         xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:svg="http://www.w3.org/2000/svg" xmlns:m="http://www.w3.org/1998/Math/MathML"
         xmlns:html="http://www.w3.org/1999/xhtml" xmlns:db="http://docbook.org/ns/docbook">
  <title>Installation of the &name-rep; with &name-jasper;</title>

  <para>The &name-rep; is based on the &name-idoutils; backend and just like the &name-core;, it will support all major database
  platforms.</para>

  <para>Here we'll give you some instructions on how to install the &name-rep; with &name-jasper;.</para>

  <para><emphasis role="bold">Prerequisites</emphasis></para>

  <para>You need &name-core; and &name-idoutils; installed and running. &name-rep; also requires a system to run the <link
  xlink:href="http://jasperforge.org/projects/jasperserver">&name-jasper;</link> based on <link
  xlink:href="http://tomcat.apache.org">&name-tomcat;</link>.</para>

  <note>
    <para>If you don't have &name-icinga; yet please follow the instructions given in the "<link
    linkend="quickstart-idoutils">quickstart-idoutils</link>" documentation.</para>
  </note>

  <para><emphasis role="bold">Install the &name-jasper;</emphasis></para>

  <para>You can use the &name-jasper; installation binary or the specific WAR-Archive to deploy the software in an existing engine.</para>

  <itemizedlist>
    <listitem>
      <para>Install from binary</para>

      <para>You can use the &name-jasper;-ce-linux-installer provided on <link
      xlink:href="http://sourceforge.net/projects/jasperserver/files/">Sourceforge</link> with &name-mysql; database and &name-tomcat;
      server included. Just execute the installer-binary which leads you through the install process.</para>
    </listitem>

    <listitem>
      <para>Install WAR-Archive</para>

      <para>You can deploy the &name-jasper;-CE WAR into an existing &name-tomcat;6 server and use the existing &name-icinga; database for
      the repository. Here we describe the WAR-installation into a &name-tomcat;6 server. Also checkout the official &name-jasper;
      Installation Guide <link xlink:href="http://sourceforge.net/projects/jasperserver/files/">here.</link></para>
    </listitem>
  </itemizedlist>

  <para><emphasis role="bold">Install &name-tomcat; using your OS repositories</emphasis></para>

  <para><emphasis>&name-fedora;/&name-rhel;/&name-centos;/&name-opensuse;/&name-sles;</emphasis></para>

  <programlisting> #&gt; yum install tomcat6</programlisting>

  <para><emphasis>&name-debian;/&name-ubuntu;</emphasis></para>

  <programlisting> #&gt; apt-get install tomcat6</programlisting>

  <para><emphasis role="bold">Install &name-jasper; CE into your &name-tomcat; Server</emphasis></para>

  <itemizedlist>
    <listitem>
      <para>Download jasperserver-ce-x.x.x-bin.zip from <link
      xlink:href="http://sourceforge.net/projects/jasperserver/files/">Sourceforge/Jasper</link></para>
    </listitem>

    <listitem>
      <para>Follow the installation documentation published on <link xlink:href="http://sourceforge.net/projects/jasperserver/files/">
      Sourceforge/Jasper</link> (&name-jasper;-CE-Install-Guide.pdf)</para>
    </listitem>
  </itemizedlist>

  <para>After successful &name-jasper; installation the interface is reachable at http://&lt;yourhost&gt;:8080/jasperserver and you are able
  to login with jasperadmin/jasperadmin and go to the next step. Please change the default password as soon as possible.</para>

  <para>In case of any errors consult the &name-jasper; Troubleshooting Guide</para>

  <para><emphasis role="bold">Download the Templates</emphasis></para>

  <itemizedlist>
    <listitem>
      <para>Download the &name-rep; package from <link
      xlink:href="http://sourceforge.net/projects/icinga/files/">Sourceforge/Icinga</link></para>
    </listitem>

    <listitem>
      <para><emphasis role="bold">Or</emphasis> using GIT: you can also download all templates and the current servlet implementation in our
      <link xlink:href="git://git.icinga.org/icinga-reports.git/">:&url-icingagit-rep;</link>.</para>

      <para>Take your clone from the icinga-reports.git to get a fresh branch</para>

      <programlisting>#&gt; git clone git://git.icinga.org/icinga-reports.git</programlisting>
    </listitem>

    <listitem>
      <para><emphasis role="bold">Or</emphasis> download the software using <link
      xlink:href="https://git.icinga.org/index?p=icinga-reports.git;a=snapshot;h=refs/heads/master;sf=tgz">https://git.icinga.org/index?p=icinga-reports.git;a=snapshot;h=refs/heads/master;sf=tgz</link>.</para>
    </listitem>
  </itemizedlist>

  <para><emphasis role="bold">Install the &name-rep; package</emphasis></para>

  <para>Unpack the downloaded file and copy it to your &name-jasper; directory.</para>

  <programlisting> #&gt; tar xzvf icinga-reports-xxx.tar.gz
 #&gt; cp icinga-reports-&lt;-version&gt;/jasperreports/package/icinga-reports.zip /opt/jasperserver/scripts/
 #&gt; cd /opt/jasperserver/scripts/</programlisting>

  <para>Importing the whole reporting package requires just one command: <programlisting> #&gt; ./js-import.sh --input-zip icinga-reports.zip</programlisting></para>

  <para>If you want to update an existing repository please use the following command: <programlisting> #&gt; ./js-import.sh --input-zip icinga-reports.zip --update</programlisting></para>

  <para>You can export the whole &name-icinga; part of the repository with the following command: <programlisting> #&gt; ./js-export.sh --uris /Icinga --output-zip icinga-reports.zip</programlisting></para>

  <note>
    <para>If the import scripts fails, please check your jasperserver.xml for the current user and password. You can change the default user
    and password in &lt;jasperserver-ce-dir&gt;/scripts/config/js.jdbc.properties</para>
  </note>

  <note>
    <para>The export-/import-process is explained in detail in chapter 5.12 of the &name-jasper; CE-Install-Guide</para>
  </note>

  <para><emphasis role="bold">Install the JAVA classes for SLA-Reports</emphasis></para>

  <para>Generating automatic reports for last week, last month or last year requires to calculate the dates automatically for the specific
  reports. To use that feature you have to install the icinga-reporting.jar archive into the Jasper lib directory. It should be in the
  WEB-INF folder of your installation. Please don't forget to restart your jasper-server after installation.</para>

  <para><emphasis role="bold">Configure quartz the scheduler</emphasis></para>

  <para>The reporting distribution is done via quartz scheduler. To configure the sender mail and your local gateways please edit the
  following file &lt;tomcat_home&gt;/webapps/jasperserver/WEB-INF/js.quartz.properties. Please restart the tomcat server to activate the new
  settings. <programlisting>service tomcat6 restart or /etc/init.d/tomcat restart</programlisting></para>

  <para><emphasis role="bold">Configure your database connection</emphasis></para>

  <para>Login to http://localhost:8080/jasperserver with jasperadmin/jasperadmin.</para>

  <para>After a successful package installation you will find the datasource here:</para>

  <para>/root/Icinga/datasource (be sure that <emphasis role="bold">Refine </emphasis>contains "changed by anyone").</para>

  <para>- Edit the existing datasource and configure your values.</para>

  <para>- Test the configuration and save the connection.</para>

  <para>- All reports in our package point to this datasource and should be able to run.</para>

  <note>
    <para>Remember to clear the search field and set the 4 dropdowns to the following positions to find the datasource:</para>
  </note>

  <itemizedlist>
    <listitem>
      <para>"Changed by anyone" (already mentioned above)</para>
    </listitem>

    <listitem>
      <para>"All"</para>
    </listitem>

    <listitem>
      <para>"Any time"</para>
    </listitem>

    <listitem>
      <para>"Any schedule"</para>
    </listitem>
  </itemizedlist>

  <para>After this is done, hit search to "apply" the filters. Now you should be able to see the data sources. Default for dropdown filter
  #2 is Visualization type, which hides data sources.</para>

  <para><emphasis role="bold">Different table prefix</emphasis></para>

  <para>If you changed your table prefix during installation you can replace the existing prefixes using the following script.</para>

  <programlisting> grep -l -r " icinga_" .  | xargs sed -i.BAK -e 's/ icinga_/ /g'
 grep -l -r "icinga_" . | xargs sed -i.BAK -e 's/^icinga_//g'
 find . -iname "*BAK" -exec rm -f {} \;</programlisting>

  <para><emphasis role="bold">Known Bugs:</emphasis> If you don't see any graph labels in a PDF export please switch from OpenJDK to
  SUNJava.</para>

  <informaltable frame="none">
    <tgroup cols="2">
      <colspec colname="c1" colwidth="50*" />

      <colspec colname="c2" colwidth="50*" />

      <tbody>
        <row>
          <entry><para><figure>
              <title>&name-rep; in &name-web;</title>

              <mediaobject>
                <imageobject role="html">
                  <imagedata fileref="../images/rep_avail.png" format="PNG"></imagedata>
                </imageobject>
              </mediaobject>
            </figure></para></entry>

          <entry><para><figure>
              <title>&name-rep; TOP10 in &name-web;</title>

              <mediaobject>
                <imageobject role="html">
                  <imagedata fileref="../images/reptop10.png" format="PNG"></imagedata>
                </imageobject>
              </mediaobject>
            </figure></para></entry>
        </row>
      </tbody>
    </tgroup>
  </informaltable>

  <para><emphasis role="bold">Integration into &name-web;</emphasis></para>

  <para><emphasis>Prerequisites</emphasis></para>

  <itemizedlist>
    <listitem>
      <para>icinga-core</para>
    </listitem>

    <listitem>
      <para>mysql running</para>
    </listitem>

    <listitem>
      <para>ido2db module configured and writing into the database</para>
    </listitem>

    <listitem>
      <para>&name-web; installed</para>
    </listitem>

    <listitem>
      <para>Jasper server installed and running</para>
    </listitem>

    <listitem>
      <para>icinga-reporting package installed on Jasper server</para>
    </listitem>
  </itemizedlist>

  <para><emphasis>Install</emphasis></para>

  <para>The reporting cronk is fully integrated into &name-web; so you don't have to install anything additional.</para>

  <para><emphasis>Configuration</emphasis></para>

  <para>Depending on your current environment you have to configure the cronk to set the Jasper server location and user credentials. The
  configuration is set in the reporting module<programlisting> $ cd app/modules/Reporting/config/
 $ ls autoload.xml config_handlers.xml module.xml routing.xml
 $ vi module.xml</programlisting><programlisting> &lt;!-- Jasper configurations --&gt;
 &lt;setting name="jasperconfig.default"&gt;
    &lt;ae:parameter name="jasper_url"&gt;http://10.121.0.95:8080/jasperserver&lt;/ae:parameter&gt;
    &lt;ae:parameter name="jasper_user"&gt;jasperadmin&lt;/ae:parameter&gt;
    &lt;ae:parameter name="jasper_pass"&gt;jasperadmin&lt;/ae:parameter&gt;
    &lt;ae:parameter name="tree_root"&gt;/Icinga/reports&lt;/ae:parameter&gt;
 &lt;/setting&gt;
 &lt;!-- Custom config if I have more that one --&gt;
 &lt;!--
 &lt;setting name="jasperconfig.custom1"&gt;
    &lt;ae:parameter name="jasper_url"&gt;http://127.0.0.175/jasperserver&lt;/ae:parameter&gt;
    &lt;ae:parameter name="jasper_user"&gt;custom_user&lt;/ae:parameter&gt;
    &lt;ae:parameter name="jasper_pass"&gt;custom_passwd&lt;/ae:parameter&gt;
 &lt;/setting&gt;
 --&gt;</programlisting>Please alter the jasperconfig.default to suit your environment and change jasper_url, jasper_user and
  jasper_pass.</para>

  <para>You can integrate more than one Jasper server. The configuration name will be included into the reporting cronk later. Please select
  a unique name for each configuration.</para>

  <para>The XML configuration is prefixed. The full name for 'jasperconfig.default' is modules.reporting.jasperconfig.default. The long name
  is the real config setting for using in the cronks configuration.</para>

  <para>The default <filename>/Icinga/reports</filename> is the path for the icinga-reporting package but you can run every report
  configured with Jasper through the cronk. If you want to use different people for different locations you have to create more cronks with
  groups_only permissions.</para>

  <para><emphasis>Cronk configuration</emphasis></para>

  <para>The Jasper config is ready. Now you need a cronk and tell it which configuration you want to use. Go to your cronk configuration
  (<filename>cronks.xml</filename>) and add a new cronk like the following:</para>

  <note>
    <para>Due to config changes between 1.4 and 1.5 there are several locations for the cronk settings. Please have a look in the other
    document resource where it could be</para>
  </note>

  <programlisting> &lt;cronk name="icingaReportingDefault"&gt;
    &lt;ae:parameter name="module"&gt;Reporting&lt;/ae:parameter&gt;
    &lt;ae:parameter name="action"&gt;Cronk.Main&lt;/ae:parameter&gt;
    &lt;ae:parameter name="hide"&gt;false&lt;/ae:parameter&gt;
    &lt;ae:parameter name="description"&gt;Seamless Jasper Integration&lt;/ae:parameter&gt;
    &lt;ae:parameter name="name"&gt;Reporting&lt;/ae:parameter&gt;
    &lt;ae:parameter name="categories"&gt;reporting&lt;/ae:parameter&gt;
    &lt;ae:parameter name="image"&gt;cronks.Weather Could Sun&lt;/ae:parameter&gt;
    &lt;ae:parameter name="ae:parameter"&gt;
       &lt;ae:parameter name="jasperconfig"&gt;modules.reporting.jasperconfig.default&lt;/ae:parameter&gt;
       &lt;ae:parameter name="enable_onthefly"&gt;1&lt;/ae:parameter&gt;
       &lt;ae:parameter name="enable_repository"&gt;1&lt;/ae:parameter&gt;
       &lt;ae:parameter name="enable_scheduling"&gt;1&lt;/ae:parameter&gt;
    &lt;/ae:parameter&gt;
 &lt;/cronk&gt;</programlisting>

  <para>Have you noticed the configuration string? This is the string you configured in the <filename>module.xml</filename> shown in the
  topic before.</para>

  <para>You can also enable some modes for this cronk:</para>

  <itemizedlist>
    <listitem>
      <para><code>enable_onthefly</code> The "create reports on the fly" mode. It allows you to create your reports in the icinga-web,
      taking previews and selecting your outputs etc ...</para>
    </listitem>

    <listitem>
      <para><code>enable_repository</code> A repository view. If you have scheduled reports which create the output in the Jasper server
      virtual directory. You can download Jasper resources and preview content.</para>
    </listitem>
  </itemizedlist>

  <para></para>

  <para>Feel free to edit our sample reports with iReport and change these to your needs :)</para>

  <para>That's all, you're done!</para>

  <indexterm zone="reporting">
    <primary>&name-rep; with &name-jasper;</primary>

    <secondary>&name-rep;</secondary>
  </indexterm>
</section>
